#!/bin/bash

echo "Running postinstall script"

readonly nodeDir="/Library/Concordium Node/__VERSION__"
readonly installConfigFile="/tmp/software.concordium.node.install.config"
readonly serviceFileCollectorMainnet="/Library/LaunchDaemons/software.concordium.mainnet.node-collector.plist"
readonly serviceFileCollectorTestnet="/Library/LaunchDaemons/software.concordium.testnet.node-collector.plist"

# Ensure the local bin folder exists
echo "Ensuring '/usr/local/bin' exists"
if [ ! -d "/usr/local/bin" ]; then
    mkdir "/usr/local/bin"
fi

# Create/replace symlinks that are in PATH
echo "Creating symlinks to node and collector"
ln -f -s "$nodeDir/concordium-node" "/usr/local/bin/concordium-node-__VERSION__"
ln -f -s "$nodeDir/node-collector" "/usr/local/bin/concordium-node-collector-__VERSION__"

# Use data from install configuration
echo 'Configuring services'
source "$installConfigFile"
echo "-- Mainnet:"
echo "  -- Node name: $CONCORDIUM_NODE_INSTALL_MAINNET_NODE_NAME"
sed -i '' -e 's/__NODE_NAME__/'"$CONCORDIUM_NODE_INSTALL_MAINNET_NODE_NAME"'/g' "$serviceFileCollectorMainnet"

echo "-- Testnet:"
echo "  -- Node name: $CONCORDIUM_NODE_INSTALL_TESTNET_NODE_NAME"
sed -i '' -e 's/__NODE_NAME__/'"$CONCORDIUM_NODE_INSTALL_TESTNET_NODE_NAME"'/g' "$serviceFileCollectorTestnet"

echo "Postinstall finished"
exit 0
